{% extends "base.html" %}
{% block title %}标签体系图 - BNDS Blog{% endblock %}
{% macro render_node(node) -%}
    {% set info = stats.get(node['id']) %}
    {% set child_id = 'tag-children-' ~ node['id'] %}
    <li class="tag-node{% if node['children'] %} has-children{% endif %}">
        <div class="tag-node-card">
            <div class="tag-node-header">
                {% if node['children'] %}
                    <button class="tag-toggle" type="button" aria-expanded="false" aria-controls="{{ child_id }}" data-toggle="#{{ child_id }}" title="折叠/展开">
                        <span class="tag-toggle-icon"></span>
                    </button>
                {% endif %}
                <h3>{{ node['tag'] or '根节点' }}</h3>
                <span class="muted-text">共有 {{ info["posts"] | length if info else 0 }} 篇</span>
            </div>
            <p class="tag-path">
                ·路径
                {% if info and info["path_tags"] %}
                    {{ info["path_tags"] | join(' / ') }}
                {% else %}
                    根部标签
                {% endif %}
            </p>
            <a class="link-more" href="{{ url_for('tag.node_detail', node_id=node['id']) }}">查看详情</a>
        </div>
        {% if node['children'] %}
            <ul class="tag-tree-children is-collapsed" id="{{ child_id }}">
                {% for child in node['children'] %}
                    {{ render_node(child) }}
                {% endfor %}
            </ul>
        {% endif %}
    </li>
{%- endmacro %}
{% block content %}
<section class="card tree-card">
    <h1>标签体系图</h1>
    <p class="form-tip">从根节点到子节点依次代表更细的分类，点击节点可查看文章与作者统计。</p>
    <ul class="tag-tree">
        {{ render_node(hierarchy) }}
    </ul>
</section>
{% endblock %}
{% block extra_scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.tag-toggle').forEach(function (button) {
                var targetSelector = button.getAttribute('data-toggle');
                if (!targetSelector) {
                    return;
                }
                button.addEventListener('click', function () {
                    var target = document.querySelector(targetSelector);
                    if (!target) {
                        return;
                    }
                    var expanded = button.getAttribute('aria-expanded') === 'true';
                    var nextState = !expanded;
                    button.setAttribute('aria-expanded', nextState.toString());
                    if (nextState) {
                        target.classList.remove('is-collapsed');
                    } else {
                        target.classList.add('is-collapsed');
                    }
                });
            });
        });
    </script>
{% endblock %}
