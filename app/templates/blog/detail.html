{% extends "base.html" %}
{% import "_macros/assets.html" as assets with context %}
{% block title %}{{ post['title'] }} - BNDS Blog{% endblock %}
{% block extra_head %}
    {{ super() }}
    {{ assets.markdown_view_styles() }}
    {{ assets.markdown_editor_styles() }}
{% endblock %}
{% block extra_scripts %}
    {{ super() }}
    {{ assets.markdown_view_scripts() }}
    {{ assets.markdown_editor_scripts() }}
{% endblock %}
{% block content %}
<article class="post-detail card">
    <header class="post-header">
        <h1>{{ post['title'] }}</h1>
        <div class="post-meta">
            <span>
                作者：
                <a href="{{ url_for('blog.user_profile', username=post['author_username']) }}">
                    {% if post['author_real_name'] %}
                        {{ post['author_real_name'] }}（{{ post['author_username'] }}）
                    {% else %}
                        {{ post['author_username'] }}
                    {% endif %}
                </a>
            </span>
            <span>发布：{{ post['created_at'] }}</span>
            <span>更新：{{ post['updated_at'] }}</span>
        </div>
        {% if post['tags'] %}
        <div class="post-tags">
            {% for tag in post['tags'] %}
                <span class="tag-badge">{{ tag }}</span>
            {% endfor %}
        </div>
        {% endif %}
        <div class="post-favorite">
            <span class="favorite-count-label">收藏：{{ post['favorite_count'] }}</span>
            {% if current_user.is_authenticated %}
                <form class="favorite-toggle-form" method="post" action="{{ url_for('blog.favorite', post_id=post['id']) }}">
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <input type="hidden" name="action" value="{{ 'remove' if post['is_favorited'] else 'add' }}">
                    <button type="submit" class="button secondary">
                        {% if post['is_favorited'] %}取消收藏{% else %}收藏此文章{% endif %}
                    </button>
                </form>
            {% else %}
                <span class="favorite-login-tip">
                    <a href="{{ url_for('auth.login', next=request.path) }}">登录</a>后可收藏此文章
                </span>
            {% endif %}
        </div>
    </header>
    <section class="post-body markdown-body">
        {{ post['content'] | markdown }}
    </section>
</article>

{% if can_edit %}
    <form class="post-actions" method="post" action="{{ url_for('blog.delete', post_id=post['id']) }}" onsubmit="return confirm('确定要删除这篇文章吗？');">
        <a class="button" href="{{ url_for('blog.edit', post_id=post['id']) }}">编辑</a>
        <button type="submit" class="button danger">删除</button>
    </form>
{% endif %}

<section class="comments card">
    <header>
        <h2>评论</h2>
        <p class="comment-count">{{ comments | length }} 条讨论</p>
    </header>
    {% if comments %}
        <div class="comment-list">
            {% for comment in comments %}
                <article class="comment-item" id="comment-{{ comment['id'] }}">
                    <div class="comment-meta">
                        <strong>
                            <a href="{{ url_for('blog.user_profile', username=comment['author']) }}">
                                {% if comment['author_real_name'] %}
                                    {{ comment['author_real_name'] }}（{{ comment['author'] }}）
                                {% else %}
                                    {{ comment['author'] }}
                                {% endif %}
                            </a>
                        </strong>
                        <span>{{ comment['created_at'] }}</span>
                        {% if current_user.is_authenticated and (current_user.is_admin or comment['author'] == current_user.username) %}
                            <form method="post"
                                  action="{{ url_for('blog.delete_comment', post_id=post['id'], comment_id=comment['id']) }}"
                                  class="comment-delete-form"
                                  onsubmit="return confirm('确定要删除这条评论吗？');">
                                <button type="submit" class="button danger ghost small">删除</button>
                            </form>
                        {% endif %}
                    </div>
                    <div class="comment-body markdown-body">
                        {{ comment['content'] | markdown }}
                    </div>
                </article>
            {% endfor %}
        </div>
    {% else %}
        <p class="empty-state">暂时还没有评论，欢迎留下第一条反馈。</p>
    {% endif %}

    {% if current_user.is_authenticated %}
        <div class="comment-form">
            <h3>发表新评论</h3>
            <form method="post" class="comment-editor-form">
                <label for="content">评论内容</label>
                <div class="markdown-editor compact" data-markdown-editor>
                    <div class="markdown-toolbar" role="toolbar" aria-label="Markdown 工具栏">
                        <button type="button" class="markdown-tool" data-md-prefix="# " title="插入一级标题">#</button>
                        <button type="button" class="markdown-tool" data-md-surround="**" title="加粗">Bold</button>
                        <button type="button" class="markdown-tool" data-md-surround="*" title="斜体">Italic</button>
                        <button type="button" class="markdown-tool" data-md-surround="`" title="行内代码">Code</button>
                        <button type="button" class="markdown-tool" data-md-prefix="- " title="无序列表">List</button>
                    </div>
                    <div class="markdown-panels">
                        <div class="markdown-panel markdown-panel-editor">
                            <textarea id="content"
                                      name="content"
                                      rows="5"
                                      placeholder="支持 Markdown 语法，比如 **加粗** 和 ```代码```"
                                      data-required-message="评论内容不能为空"
                                      data-markdown-source></textarea>
                        </div>
                        <div class="markdown-panel markdown-panel-preview">
                            <div class="markdown-preview markdown-body" aria-live="polite"></div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="button primary">提交评论</button>
            </form>
        </div>
    {% else %}
        <p class="comment-signin">
            <a href="{{ url_for('auth.login', next=request.path) }}">登录</a> 后即可参与讨论。
        </p>
    {% endif %}
</section>
{% endblock %}
