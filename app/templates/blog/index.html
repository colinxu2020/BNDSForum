{% extends "base.html" %}
{% import "_macros/assets.html" as assets with context %}
{% block title %}文章列表 - BNDS Blog{% endblock %}
{% block extra_head %}
    {{ super() }}
    {{ assets.markdown_view_styles() }}
    <style>
        .search-results-info {
            margin: 1rem 0;
            padding: 0.5rem;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .hidden {
            display: none;
        }
        
        /* 调整搜索框位置，避免遮挡导航栏 */
        .search-container {
            position: absolute;
            /* top: 80px; 向下移动，避免遮挡导航栏 */
            top:20px;
            right: 20px;
            width: 200px;
            z-index: 100;
        }
        
        .input-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            /* background: rgba(218, 218, 218, 0.95); */
            background: #ddd;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .input-search:focus {
            outline: none;
            border-color: #6c5ce7;
            box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.1);
            background: white;
        }
        
        /* 调整hero部分的布局，为搜索框留出空间 */
        .hero.card {
            position: relative;
            padding-right: 240px;
            margin-top: 20px; /* 为搜索框留出更多空间 */
        }
        
        /* 移动设备适配 */
        @media (max-width: 768px) {
            .search-container {
                position: static;
                width: 100%;
                margin: 10px 0;
            }
            
            .hero.card {
                padding-right: 0;
            }
        }
    </style>
{% endblock %}
{% block extra_scripts %}
    {{ super() }}
    {{ assets.markdown_view_scripts() }}
{% endblock %}
{% block content %}
<!-- 搜索框移动到右上角，但避免遮挡导航栏 -->


<section class="hero card">
    <div class="search-container">
        <input type="text" id="searchInput" class="input-search" placeholder="输入搜索关键字">
    </div>
    <div class="hero-content">
        <h1>最新文章</h1>
        <p>探索同学们的灵感与观点，博客现已全面支持 Markdown 排版。</p>
        {% if current_user.is_authenticated %}
            <a class="button primary" href="{{ url_for('blog.create') }}">写新文章</a>
        {% else %}
            <a class="button primary" href="{{ url_for('auth.login', next=request.path) }}">登录后创作</a>
        {% endif %}
    </div>
    {% if normal_tags %}
        <div class="hero-tags">
            <h2>常用标签</h2>
            <div class="tag-list">
                {% for tag in normal_tags %}
                    <span class="tag-chip">{{ tag }}</span>
                {% endfor %}
            </div>
            <a class="link-more" href="{{ url_for('tag.class_overview') }}">查看班级视图 →</a>
        </div>
    {% endif %}
</section>

<section>
    <script type="application/ld+json" id="datas">
    {{ posts | tojson }}
    </script>
    
    <!-- 搜索信息显示区域 -->
    <div id="searchResultsInfo" class="search-results-info hidden"></div>
</section>

<section class="post-list">
    <!-- 原始文章列表 -->
    <!-- <div id="originalPosts">
        {% if posts %}
            {% for post in posts %}
                <article class="post-card card" data-post-id="{{ post['id'] }}">
                    <header>
                        <h2><a href="{{ url_for('blog.detail', post_id=post['id']) }}">{{ post['title'] }}</a></h2>
                        <div class="post-meta">
                            <span>
                                作者：
                                <a href="{{ url_for('blog.user_profile', username=post['author_username']) }}">
                                    {% if post['author_real_name'] %}
                                        {{ post['author_real_name'] }}（{{ post['author_username'] }}）
                                    {% else %}
                                        {{ post['author_username'] }}
                                    {% endif %}
                                </a>
                            </span>
                            <span>发布：{{ post['created_at'] }}</span>
                            <span>更新：{{ post['updated_at'] }}</span>
                        </div>
                    </header>
                    {% if post['tags'] %}
                        <div class="post-tags">
                            {% for tag in post['tags'] %}
                                <span class="tag-badge">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="post-excerpt markdown-body clamp-4">
                        {{ post['content'] | markdown }}
                    </div>
                    <div class="post-footer">
                        <a class="link-more" href="{{ url_for('blog.detail', post_id=post['id']) }}">阅读全文</a>
                        {% if current_user.is_authenticated and (current_user.is_admin or post['author_username'] == current_user.username) %}
                            <div class="post-shortcuts">
                                <a href="{{ url_for('blog.edit', post_id=post['id']) }}">编辑</a>
                            </div>
                        {% endif %}
                    </div>
                </article>
            {% endfor %}
        {% else %}
            <p class="empty-state">还没有文章，成为第一位作者吧！</p>
        {% endif %}
    </div> -->
    
    <!-- 搜索结果容器 -->
    <div id="searchResults" class="hidden"></div>
</section>

<script>
    // 工具函数
var HtmlUtil = {
    htmlEncode: function(html) {
        var tempDiv = document.createElement('div');
        (tempDiv.textContent != undefined) ? (tempDiv.textContent = html) : (tempDiv.innerText = html);
        var output = tempDiv.innerHTML;
        tempDiv = null;
        return output;
    },
    
    htmlDecode: function(text) {
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = text;
        var output = tempDiv.innerText || tempDiv.textContent;
        tempDiv = null;
        return output;
    }
};

// 搜索功能
class PostSearch {
constructor() {
    // this.originalPosts = document.getElementById('originalPosts');
    this.searchResults = document.getElementById('searchResults');
    this.searchInfo = document.getElementById('searchResultsInfo');
    this.searchInput = document.getElementById('searchInput');
    
    this.allPosts = this.loadPostsData();
    
    // 立即执行空搜索
    this.displayAllPosts();
    
    this.bindEvents();
}
    
    // 加载文章数据
    loadPostsData() {
        try {
            const postsElement = document.getElementById("datas");
            if (!postsElement) {
                console.error('找不到文章数据元素');
                return [];
            }
            
            const posts = HtmlUtil.htmlDecode(postsElement.innerHTML);
            return JSON.parse(posts);
        } catch (error) {
            console.error('加载文章数据失败:', error);
            return [];
        }
    }
    
    // 绑定事件
    bindEvents() {
        // 移除按钮事件，只保留输入事件
        this.searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.performSearch();
            }
        });
        
        // 添加输入时实时搜索
        this.searchInput.addEventListener('input', () => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.performSearch();
            }, 300);
        });
    }
    
    // 执行搜索
    performSearch() {
        const keyword = this.searchInput.value.trim();
        
        // 如果关键词为空，显示所有文章
        if (!keyword) {
            this.displayAllPosts();
            return;
        }
        
        const results = this.searchPosts(keyword);
        this.displayResults(results, keyword);
    }
    
// 显示所有文章
displayAllPosts() {
    // 隐藏原始列表，显示结果容器
    // this.originalPosts.classList.add('hidden');
    this.searchResults.classList.remove('hidden');
    
    // 隐藏搜索信息区域
    this.searchInfo.classList.add('hidden');
    
    // 生成所有文章的HTML
    if (this.allPosts.length === 0) {
        this.searchResults.innerHTML = '<p class="empty-state">还没有文章，成为第一位作者吧！</p>';
    } else {
        this.searchResults.innerHTML = this.allPosts.map(post => this.generatePostHTML(post, '')).join('');
    }
}
    
    // 搜索文章
    searchPosts(keyword) {
        const lowerKeyword = keyword.toLowerCase();
        
        return this.allPosts.filter(item => {
            if (!item) return false;
            
            const searchFields = [
                item.title,
                item.content,
                item.author_username,
                item.author_real_name
            ];
            
            return searchFields.some(field => 
                field && field.toLowerCase().includes(lowerKeyword)
            );
        });
    }
    
    // 显示搜索结果
    displayResults(results, keyword) {
        // 隐藏原始列表，显示结果容器
        // this.originalPosts.classList.add('hidden');
        this.searchResults.classList.remove('hidden');
        this.searchInfo.classList.remove('hidden');
        
        // 更新搜索结果信息
        const resultText = results.length === 1 ? '篇' : '篇';
        this.searchInfo.innerHTML = `找到 ${results.length} ${resultText}与"<strong>${this.escapeHtml(keyword)}</strong>"相关的文章`;
        
        // 生成搜索结果HTML
        if (results.length === 0) {
            this.searchResults.innerHTML = '<p class="empty-state">没有找到相关文章，请尝试其他关键词</p>';
        } else {
            this.searchResults.innerHTML = results.map(post => this.generatePostHTML(post, keyword)).join('');
        }
    }
    
    // 生成文章HTML（带高亮）
    generatePostHTML(post, keyword) {
        // 高亮处理函数
        const highlightText = (text) => {
            if (!text || !keyword) return this.escapeHtml(text);

            const regex = new RegExp(`(${this.escapeRegex(keyword)})`, 'gi');
            return this.escapeHtml(text).replace(regex, '<mark class="search-highlight">$1</mark>');
        };
        const favoriteCount = typeof post.favorite_count === 'number' ? post.favorite_count : 0;
        const favoriteSuffix = post.is_favorited ? ' · 已收藏' : '';
        
        // 生成标签HTML
        const tagsHTML = post.tags && post.tags.length > 0 ? 
            `<div class="post-tags">
                ${post.tags.map(tag => `<span class="tag-badge">${this.escapeHtml(tag)}</span>`).join('')}
            </div>` : '';
        
        // 处理作者显示
        let authorDisplay = post.author_username;
        if (post.author_real_name) {
            authorDisplay = `${post.author_real_name} (${post.author_username})`;
        }
        
        return `
            <article class="post-card card" data-post-id="${post.id}">
                <header>
                    <h2><a href="/post/${post.id}" target="_blank">${highlightText(post.title)}</a></h2>
                    <div class="post-meta">
                        <span>作者：<a style = "color:#a29bfe" href="/blog/user/${post.author_username}">${highlightText(authorDisplay)}</a></span>
                        <span>发布：${post.created_at}</span>
                        <span>更新：${post.updated_at}</span>
                    </div>
                </header>
                ${tagsHTML}
                <div class="post-excerpt markdown-body clamp-4">
                    ${this.generateContentExcerpt(post.content, keyword)}
                </div>
                <div class="post-footer">
                    <a class="link-more" href="/post/${post.id}">阅读全文</a>
                    <div class="post-shortcuts">
                        <span class="favorite-count">收藏：${favoriteCount}${favoriteSuffix}</span>
                    </div>
                </div>
            </article>
        `;
    }
    
    // 生成内容摘要（安全处理）
    generateContentExcerpt(content, keyword, maxLength = 200) {
        if (!content) return '';
        
        // 转换为纯文本
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        const plainText = tempDiv.textContent || tempDiv.innerText || '';
        
        // 查找关键词位置
        const lowerText = plainText.toLowerCase();
        const lowerKeyword = keyword.toLowerCase();
        const keywordIndex = lowerText.indexOf(lowerKeyword);
        
        let excerpt = '';
        if (keywordIndex !== -1) {
            // 以关键词为中心截取
            const start = Math.max(0, keywordIndex - 50);
            const end = Math.min(plainText.length, keywordIndex + keyword.length + 50);
            excerpt = plainText.substring(start, end);
            
            if (start > 0) excerpt = '...' + excerpt;
            if (end < plainText.length) excerpt = excerpt + '...';
        } else {
            // 普通截取
            excerpt = plainText.length > maxLength ? 
                plainText.substring(0, maxLength) + '...' : 
                plainText;
        }
        
        // 高亮关键词
        const regex = new RegExp(`(${this.escapeRegex(keyword)})`, 'gi');
        return this.escapeHtml(excerpt).replace(regex, '<mark class="search-highlight">$1</mark>');
    }
    
    // 工具方法
    escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    new PostSearch();
});

</script>

<style>
    .search-highlight {
    background-color: #ffeb3b;
    color: #000;
    border-radius: 1px;
    font-weight: bold;
}

.search-results-info {
    margin: 1.5rem 0;
    padding: 16px 20px;
    background: linear-gradient(135deg, #6c5ce7, #a29bfe);
    color: white;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1em;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
    border-left: 4px solid #ffd32a;
    position: relative;
    overflow: hidden;
}

.hidden {
    display: none !important;
}
</style>
{% endblock %}
