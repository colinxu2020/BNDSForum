{% extends "base.html" %}
{% import "_macros/assets.html" as assets with context %}
{% block title %}文章列表 - BNDS Blog{% endblock %}
{% block extra_head %}
    {{ super() }}
    {{ assets.markdown_view_styles() }}
    <style>
        .home-hero {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 28px 32px;
            background: linear-gradient(135deg, #0f172a, #0ea5e9);
            color: #eef6ff;
            border: none;
            box-shadow: 0 14px 32px rgba(15, 23, 42, 0.25);
            overflow: hidden;
            position: relative;
            border-radius: 18px;
        }

        .home-hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.08), transparent 35%),
                        radial-gradient(circle at 80% 0%, rgba(255,255,255,0.12), transparent 30%);
            pointer-events: none;
        }

        .home-hero .hero-text {
            max-width: 540px;
            position: relative;
            z-index: 1;
        }

        .home-hero h1 {
            font-size: 28px;
            margin-bottom: 8px;
            letter-spacing: 0.01em;
        }

        .home-hero p {
            opacity: 0.92;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .hero-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .home-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            align-items: start;
        }

        .filter-panel {
            position: sticky;
            top: 96px;
            border: none;
            box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
            background: linear-gradient(180deg, #f8fafc, #ffffff);
        }

        .filter-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700;
            margin-bottom: 8px;
            color: #0f172a;
        }

        .filter-form {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .tag-pill-grid,
        .chip-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-pill,
        .chip-option {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 999px;
            background: #e2e8f0;
            color: #0f172a;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .tag-pill:hover,
        .chip-option:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
        }

        .tag-pill input,
        .chip-option input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .tag-pill input:checked + span,
        .chip-option input:checked + span {
            color: #0ea5e9;
        }

        .tag-pill input:checked ~ .pill-sheen,
        .chip-option input:checked ~ .pill-sheen {
            opacity: 1;
        }

        .pill-sheen {
            position: absolute;
            inset: 0;
            border-radius: 999px;
            border: 1px solid #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .pill-badge {
            background: rgba(14, 165, 233, 0.14);
            color: #0369a1;
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(3, 105, 161, 0.2);
            line-height: 1;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-start;
        }

        .filter-actions .button {
            width: auto;
        }

        .search-input {
            width: 100%;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #0ea5e9;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
        }

        .post-feed {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .post-card {
            border: none;
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
        }

        .post-card header {
            margin-bottom: 10px;
        }

        .post-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .badge.category {
            background: rgba(236, 72, 153, 0.12);
            color: #be185d;
        }

        .badge.class {
            background: rgba(14, 165, 233, 0.14);
            color: #0369a1;
        }

        .badge.meta {
            background: #0f172a;
            color: #e2e8f0;
        }

        .post-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            color: #475569;
            font-weight: 600;
        }

        .post-meta span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .post-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
        }

        .favorite-chip {
            background: #0f172a;
            color: #e2e8f0;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 700;
        }

        .empty-highlight {
            text-align: center;
            padding: 28px;
            border: 1px dashed #cbd5e1;
            border-radius: 12px;
            background: #f8fafc;
        }

        @media (max-width: 1024px) {
            .home-grid {
                grid-template-columns: 1fr;
            }
            .filter-panel {
                position: relative;
                top: 0;
            }
        }
    </style>
{% endblock %}
{% block extra_scripts %}
    {{ super() }}
    {{ assets.markdown_view_scripts() }}
{% endblock %}
{% block content %}
<section class="home-hero card">
    <div class="hero-text">
        <h1>精选校园创作</h1>
        <p>从技术分享到社团故事，在这里找到属于你的灵感。左侧筛选班级和类别，即刻发现同好作品。</p>
        <div class="hero-actions">
            {% if current_user.is_authenticated %}
                <a class="button primary" href="{{ url_for('blog.create') }}">写新文章</a>
                <a class="button ghost" href="{{ url_for('blog.user_profile', username=current_user.username) }}">我的主页</a>
            {% else %}
                <a class="button primary" href="{{ url_for('auth.login', next=request.path) }}">登录后创作</a>
            {% endif %}
        </div>
    </div>
    <div class="hero-actions">
        <div class="badge meta">文章 {{ posts | length }}</div>
        <div class="badge meta">类别 {{ category_tags | length }}</div>
        <div class="badge meta">班级标签 {{ class_tags | length }}</div>
    </div>
</section>

<div class="home-grid">
    <aside class="filter-panel card">
        <form method="get" class="filter-form">
            <div class="filter-group">
                <div class="filter-title">
                    <span>班级标签</span>
                    <small class="muted-text">可多选，不选则不过滤</small>
                </div>
                <div class="tag-pill-grid">
                    {% for tag in class_tags %}
                        {% set name = tag.name if tag.name is defined else tag['name'] %}
                        {% set source = tag.source if tag.source is defined else tag['source'] %}
                        <label class="tag-pill">
                            <input type="checkbox" name="class_tag" value="{{ name }}" {% if name in filters.class_tags %}checked{% endif %}>
                            <span>{{ name }}</span>
                            {% if source == 'oj' %}
                                <span class="pill-badge">OJ 同步</span>
                            {% elif source == 'builtin' %}
                                <span class="pill-badge">默认</span>
                            {% endif %}
                            <span class="pill-sheen"></span>
                        </label>
                    {% else %}
                        <p class="muted-text">暂无班级标签，可在后台添加或同步 OJ 小组。</p>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-group">
                <div class="filter-title">
                    <span>类别</span>
                    <small class="muted-text">单选，空则不过滤</small>
                </div>
                <div class="chip-grid">
                    <label class="chip-option">
                        <input type="radio" name="category" value="" {% if not filters.category %}checked{% endif %}>
                        <span>全部类别</span>
                        <span class="pill-sheen"></span>
                    </label>
                    {% for tag in category_tags %}
                        <label class="chip-option">
                            <input type="radio" name="category" value="{{ tag }}" {% if filters.category == tag %}checked{% endif %}>
                            <span>{{ tag }}</span>
                            <span class="pill-sheen"></span>
                        </label>
                    {% endfor %}
                </div>
            </div>

            <div class="filter-group">
                <div class="filter-title">
                    <span>关键词</span>
                </div>
                <input class="search-input" type="search" name="q" value="{{ filters.keyword }}" placeholder="标题、正文或标签关键字">
            </div>

            <div class="filter-actions">
                <button type="submit" class="button primary">应用筛选</button>
                <a class="button ghost" href="{{ url_for('blog.index') }}">清除条件</a>
            </div>
        </form>
    </aside>

    <section class="post-feed">
        {% if posts %}
            {% for post in posts %}
                <article class="post-card card">
                    <header>
                        <div class="post-badges">
                            <span class="badge category">类别 · {{ post['category_tag'] }}</span>
                            <span class="badge class">班级 · {{ post['class_tag'] }}</span>
                        </div>
                        <h2><a href="{{ url_for('blog.detail', post_id=post['id']) }}">{{ post['title'] }}</a></h2>
                        <div class="post-meta">
                            <span>作者：<a href="{{ url_for('blog.user_profile', username=post['author_username']) }}">{{ post['author_display'] }}</a></span>
                            <span>发布：{{ post['created_at'] | friendly_time }}</span>
                            <span>更新：{{ post['updated_at'] | friendly_time }}</span>
                        </div>
                    </header>
                    <div class="post-excerpt markdown-body clamp-4">
                        {{ post['content'] | markdown }}
                    </div>
                    <div class="post-footer">
                        <a class="link-more" href="{{ url_for('blog.detail', post_id=post['id']) }}">阅读全文</a>
                        <span class="favorite-chip">收藏 {{ post['favorite_count'] }}</span>
                    </div>
                </article>
            {% endfor %}
        {% else %}
            <div class="empty-highlight">
                <p class="muted-text">还没有符合条件的文章，试试调整筛选或发布第一篇吧。</p>
            </div>
        {% endif %}
    </section>
</div>
{% endblock %}
