{% extends "base.html" %}
{% import "_macros/assets.html" as assets with context %}
{% set display_name = profile.get('real_name') or profile['username'] %}
{% block title %}{{ display_name }} 的主页 - BNDS Blog{% endblock %}
{% block extra_head %}
    {{ super() }}
    {{ assets.markdown_view_styles() }}
{% endblock %}
{% block extra_scripts %}
    {{ super() }}
    {{ assets.markdown_view_scripts() }}
{% endblock %}
{% block content %}
<section class="card">
    <header class="form-header">
        <h1>{{ display_name }}</h1>
        <p class="form-tip">
            用户名：{{ profile['username'] }} · 角色：{{ '管理员' if profile.get('role') == 'admin' else '普通用户' }}
        </p>
    </header>

    <div class="profile-meta">
        <div>
            <h2>真实姓名</h2>
            <p class="muted-text">公开展示，可由本人或管理员修改。</p>
            {% if can_edit_real_name %}
                <form method="post" class="form-inline">
                    <label class="sr-only" for="real_name">真实姓名</label>
                    <input type="text" id="real_name" name="real_name" value="{{ profile.get('real_name', '') }}" required>
                    <button type="submit" class="button primary">保存</button>
                </form>
            {% else %}
                <p>{{ display_name }}</p>
            {% endif %}
        </div>
        <div>
            <h2>固定标签</h2>
            <p class="muted-text">系统会自动为该用户的文章附加这些标签。</p>
            <div class="tag-collection">
                {% for tag in profile.get('constant_tags', []) %}
                    <span class="tag-badge">{{ tag }}</span>
                {% else %}
                    <span class="tag-badge muted">暂无固定标签</span>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<section class="card">
    <h2>全部文章</h2>
    {% if common_tags %}
        <form method="get" class="tag-filter-form">
            <fieldset class="filter-field tag-filter-field">
                <legend>按常见标签筛选</legend>
                <div class="checkbox-chip-group">
                    {% for tag in common_tags %}
                        <label class="checkbox-chip">
                            <input type="checkbox" name="tag" value="{{ tag }}" {% if tag in selected_tags %}checked{% endif %}>
                            <span>{{ tag }}</span>
                        </label>
                    {% endfor %}
                </div>
                <div class="filter-actions">
                    <button type="submit" class="button primary small">应用</button>
                    <a class="button ghost small" href="{{ url_for('blog.user_profile', username=profile['username']) }}">清除</a>
                </div>
            </fieldset>
        </form>
    {% endif %}
    {% if posts %}
        <div class="post-list">
            {% for post in posts %}
                <article class="post-card card">
                    <header>
                        <h3><a href="{{ url_for('blog.detail', post_id=post['id']) }}">{{ post['title'] }}</a></h3>
                        <div class="post-meta">
                            <span>发布：{{ post['created_at'] }}</span>
                            <span>更新：{{ post['updated_at'] }}</span>
                        </div>
                    </header>
                    {% if post['tags'] %}
                        <div class="post-tags">
                            {% for tag in post['tags'] %}
                                <span class="tag-badge">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="post-excerpt markdown-body clamp-3">
                        {{ post['content'] | markdown }}
                    </div>
                    <div class="post-footer">
                        <a class="link-more" href="{{ url_for('blog.detail', post_id=post['id']) }}">阅读全文</a>
                        <div class="post-shortcuts">
                            <span class="favorite-count">
                                收藏：{{ post['favorite_count'] }}{% if post['is_favorited'] %}（已收藏）{% endif %}
                            </span>
                            {% if current_user.is_authenticated %}
                                <form class="favorite-inline-form" method="post" action="{{ url_for('blog.favorite', post_id=post['id']) }}">
                                    <input type="hidden" name="next" value="{{ request.path }}">
                                    <input type="hidden" name="action" value="{{ 'remove' if post['is_favorited'] else 'add' }}">
                                    <button type="submit" class="button secondary small">
                                        {% if post['is_favorited'] %}取消收藏{% else %}收藏{% endif %}
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </article>
            {% endfor %}
        </div>
    {% else %}
        {% if selected_tags %}
            <p class="empty-state">没有符合所选常见标签组合的文章。</p>
        {% else %}
            <p class="empty-state">该用户还没有发布文章。</p>
        {% endif %}
    {% endif %}
</section>

{% if viewing_self %}
<section class="card">
    <h2>我的收藏</h2>
    {% if favorite_posts %}
        <div class="post-list">
            {% for post in favorite_posts %}
                <article class="post-card card">
                    <header>
                        <h3><a href="{{ url_for('blog.detail', post_id=post['id']) }}">{{ post['title'] }}</a></h3>
                        <div class="post-meta">
                            <span>收藏于：{{ post['favorited_at'] }}</span>
                            <span>作者：{{ post['author_display'] }}</span>
                        </div>
                    </header>
                    {% if post['tags'] %}
                        <div class="post-tags">
                            {% for tag in post['tags'] %}
                                <span class="tag-badge">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="post-excerpt markdown-body clamp-3">
                        {{ post['content'] | markdown }}
                    </div>
                    <div class="post-footer">
                        <a class="link-more" href="{{ url_for('blog.detail', post_id=post['id']) }}">阅读全文</a>
                        <div class="post-shortcuts">
                            <span class="favorite-count">总收藏：{{ post['favorite_count'] }}</span>
                            <form class="favorite-inline-form" method="post" action="{{ url_for('blog.favorite', post_id=post['id']) }}">
                                <input type="hidden" name="next" value="{{ request.path }}">
                                <input type="hidden" name="action" value="remove">
                                <button type="submit" class="button secondary small">取消收藏</button>
                            </form>
                        </div>
                    </div>
                </article>
            {% endfor %}
        </div>
    {% else %}
        <p class="empty-state">你还没有收藏任何文章，浏览喜欢的文章时可以点击“收藏”按钮。</p>
    {% endif %}
</section>
{% endif %}
{% endblock %}
