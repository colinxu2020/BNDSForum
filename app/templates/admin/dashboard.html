{% extends "base.html" %}
{% block title %}管理后台 - BNDS Blog{% endblock %}
{% block content %}
<section class="card admin-hero">
    <h1>管理后台</h1>
    <p class="form-tip">维护常用标签、管理标签树结构，并快速查看用户概况。</p>
    <div class="action-group">
        <a class="button primary" href="{{ url_for('tag.tree_view') }}">查看标签树</a>
        <a class="button ghost" href="{{ url_for('admin.user_list') }}">用户管理</a>
        <a class="button ghost" href="{{ url_for('admin.export_posts') }}">导出博客 Markdown</a>
    </div>
</section>

<section class="grid two-column">
    <div class="card">
        <h2>常用标签</h2>
        <form class="form-inline" method="post" action="{{ url_for('admin.add_normal_tag') }}">
            <label class="sr-only" for="normal_tag_name">新增标签</label>
            <input type="text" id="normal_tag_name" name="tag_name" placeholder="输入标签名称" required>
            <button type="submit" class="button primary">添加</button>
        </form>
        {% if normal_tags %}
            <ul class="tag-manage-list">
                {% for tag in normal_tags %}
                    <li>
                        <span>{{ tag }}</span>
                        <form method="post" action="{{ url_for('admin.delete_normal_tag') }}" onsubmit="return confirm('确定删除该标签吗？');">
                            <input type="hidden" name="tag_name" value="{{ tag }}">
                            <button type="submit" class="button danger ghost">删除</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="empty-state">暂时没有常用标签。</p>
        {% endif %}
    </div>

    <div class="card">
        <h2>固定标签</h2>
        <p class="form-tip">固定标签可分配给用户并自动同步到其文章。</p>
        <form class="form-inline" method="post" action="{{ url_for('admin.add_constant_tag') }}">
            <label class="sr-only" for="constant_tag_name">新增固定标签</label>
            <input type="text" id="constant_tag_name" name="tag_name" placeholder="输入固定标签" required>
            <button type="submit" class="button primary">添加</button>
        </form>
        {% if constant_tags %}
            <ul class="tag-manage-list">
                {% for tag in constant_tags %}
                    <li>
                        <span>{{ tag }}</span>
                        <form method="post" action="{{ url_for('admin.delete_constant_tag') }}" onsubmit="return confirm('确定删除该固定标签并移除所有关联吗？');">
                            <input type="hidden" name="tag_name" value="{{ tag }}">
                            <button type="submit" class="button danger ghost">删除</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="empty-state">暂无固定标签。</p>
        {% endif %}
    </div>

    <div class="card">
        <h2>添加标签树节点</h2>
        <form class="form-grid" method="post" action="{{ url_for('admin.add_tree_node') }}">
            <div class="form-field">
                <label for="parent_id">父节点</label>
                <select id="parent_id" name="parent_id" required>
                    {% for option in parent_choices %}
                        <option value="{{ option.id }}">{{ option.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-field">
                <label for="node_tag">节点标签</label>
                <select id="node_tag" name="tag_name">
                    <option value="">（不设置标签）</option>
                    {% if constant_tags %}
                        <optgroup label="固定标签">
                            {% for tag in constant_tags %}
                                <option value="{{ tag }}">{{ tag }}</option>
                            {% endfor %}
                        </optgroup>
                    {% endif %}
                    {% if normal_tags %}
                        <optgroup label="常用标签">
                            {% for tag in normal_tags %}
                                <option value="{{ tag }}">{{ tag }}</option>
                            {% endfor %}
                        </optgroup>
                    {% endif %}
                </select>
                <p class="field-hint">可选择已存在的常用或固定标签；留空创建占位节点。</p>
            </div>
            <div class="form-actions">
                <button type="submit" class="button primary">添加节点</button>
            </div>
        </form>
    </div>
</section>

<section class="card">
    <h2>标签树概览</h2>
    <div class="responsive-table">
        <table>
            <thead>
            <tr>
                <th>节点 ID</th>
                <th>路径</th>
                <th>标签名称</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for row in tree_rows %}
                <tr>
                    <td>{{ row.id }}</td>
                    <td>{{ ' / '.join(row.path) if row.path else '根节点' }}</td>
                    <td>{{ row.tag or '（空）' }}</td>
                    <td>
                        {% if not row.is_root %}
                            <form class="inline-form" method="post" action="{{ url_for('admin.update_tree_node') }}">
                                <input type="hidden" name="node_id" value="{{ row.id }}">
                                <input type="text" name="tag" value="{{ row.tag or '' }}" placeholder="标签名称">
                                <button type="submit" class="button ghost">更新</button>
                            </form>
                            <form class="inline-form" method="post" action="{{ url_for('admin.delete_tree_node') }}" onsubmit="return confirm('确定删除该节点及其所有子节点吗？');">
                                <input type="hidden" name="node_id" value="{{ row.id }}">
                                <button type="submit" class="button danger ghost">删除</button>
                            </form>
                        {% else %}
                            <span class="muted-text">根节点不可修改</span>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

<section class="card">
    <h2>用户概况</h2>
    <p>当前共有 {{ users | length }} 位用户。</p>
    <a class="button ghost" href="{{ url_for('admin.user_list') }}">打开用户管理</a>
</section>
{% endblock %}
