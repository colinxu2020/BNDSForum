{% extends "base.html" %}
{% block title %}管理后台 - BNDS Blog{% endblock %}
{% block content %}
<section class="card admin-hero">
    <h1>管理后台</h1>
    <p class="form-tip">维护类别与班级标签，支持一键同步 BNDSOJ 小组；固定标签与用户管理入口保持可用。</p>
    <div class="action-group">
        <form class="inline-form" method="post" action="{{ url_for('admin.sync_class_tags') }}">
            <button class="button primary" type="submit">同步 BNDSOJ 班级标签</button>
        </form>
        <a class="button ghost" href="{{ url_for('admin.user_list') }}">用户管理</a>
        <a class="button ghost" href="{{ url_for('admin.export_posts') }}">导出博客 Markdown</a>
    </div>
</section>

<section class="grid two-column">
    <div class="card">
        <h2>类别标签</h2>
        <p class="form-tip">文章必须选择一个类别标签，适合按主题或栏目划分。</p>
        <form class="form-inline" method="post" action="{{ url_for('admin.add_category_tag') }}">
            <label class="sr-only" for="category_tag_name">新增类别</label>
            <input type="text" id="category_tag_name" name="tag_name" placeholder="输入类别名称" required>
            <button type="submit" class="button primary">添加</button>
        </form>
        {% if category_tags %}
            <ul class="tag-manage-list">
                {% for tag in category_tags %}
                    <li>
                        <span>{{ tag }}</span>
                        <form method="post" action="{{ url_for('admin.delete_category_tag') }}" onsubmit="return confirm('确定删除该类别标签吗？');">
                            <input type="hidden" name="tag_name" value="{{ tag }}">
                            <button type="submit" class="button danger ghost">删除</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="empty-state">暂时没有类别标签。</p>
        {% endif %}
    </div>

    <div class="card">
        <h2>班级标签</h2>
        <p class="form-tip">支持本地维护与 OJ 小组同步的标签，可多选过滤。</p>
        <form class="form-inline" method="post" action="{{ url_for('admin.add_class_tag') }}">
            <label class="sr-only" for="class_tag_name">新增班级标签</label>
            <input type="text" id="class_tag_name" name="tag_name" placeholder="输入班级或小组名称" required>
            <button type="submit" class="button primary">添加</button>
        </form>
        {% if class_tags %}
            <ul class="tag-manage-list">
                {% for tag in class_tags %}
                    {% set name = tag.name if tag.name is defined else tag['name'] %}
                    {% set source = tag.source if tag.source is defined else tag['source'] %}
                    <li>
                        <span>{{ name }}</span>
                        <span class="muted-text">
                            {% if source == 'oj' %}
                                · OJ 同步
                            {% elif source == 'builtin' %}
                                · 默认
                            {% else %}
                                · 手动
                            {% endif %}
                        </span>
                        {% if source != 'oj' and source != 'builtin' %}
                            <form method="post" action="{{ url_for('admin.delete_class_tag') }}" onsubmit="return confirm('删除后班级标签将不可选，确定吗？');">
                                <input type="hidden" name="tag_name" value="{{ name }}">
                                <button type="submit" class="button danger ghost">删除</button>
                            </form>
                        {% else %}
                            <span class="muted-text">（同步来源，后台不支持删除）</span>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="empty-state">暂未配置班级标签，可尝试同步或手动添加。</p>
        {% endif %}
    </div>
</section>

<section class="grid two-column">
    <div class="card">
        <h2>固定标签</h2>
        <p class="form-tip">分配给用户后，系统会自动附加到 TA 的所有文章。</p>
        <form class="form-inline" method="post" action="{{ url_for('admin.add_constant_tag') }}">
            <label class="sr-only" for="constant_tag_name">新增固定标签</label>
            <input type="text" id="constant_tag_name" name="tag_name" placeholder="输入固定标签" required>
            <button type="submit" class="button primary">添加</button>
        </form>
        {% if constant_tags %}
            <ul class="tag-manage-list">
                {% for tag in constant_tags %}
                    <li>
                        <span>{{ tag }}</span>
                        <form method="post" action="{{ url_for('admin.delete_constant_tag') }}" onsubmit="return confirm('确定删除该固定标签并移除所有关联吗？');">
                            <input type="hidden" name="tag_name" value="{{ tag }}">
                            <button type="submit" class="button danger ghost">删除</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="empty-state">暂无固定标签。</p>
        {% endif %}
    </div>

    <div class="card">
        <h2>用户概况</h2>
        <p>当前共有 {{ users | length }} 位用户。</p>
        <a class="button ghost" href="{{ url_for('admin.user_list') }}">打开用户管理</a>
    </div>
</section>
{% endblock %}
