{% extends "base.html" %}
{% block title %}管理后台 - BNDS Blog{% endblock %}
{% block content %}
<section class="card admin-hero">
    <h1>管理后台</h1>
    <p class="form-tip">自动同步班级与栏目结构，维护常用标签，并查看系统概况。</p>
    <div class="action-group">
        <a class="button primary" href="{{ url_for('tag.class_overview') }}">班级视图</a>
        <a class="button ghost" href="{{ url_for('admin.legacy_tag_config') }}">标签树（Legacy）</a>
        <a class="button ghost" href="{{ url_for('admin.user_list') }}">用户管理</a>
        <a class="button ghost" href="{{ url_for('admin.export_posts') }}">导出博客 Markdown</a>
    </div>
</section>

<section class="card">
    <h2>班级同步状态</h2>
    <p class="form-tip">
        班级及成员列表会在用户登录时通过 BNDSOJ 自动刷新。
        当前共同步 {{ class_overview | length }} 个班级。
    </p>
    {% if class_overview %}
        <div class="responsive-table">
            <table>
                <thead>
                <tr>
                    <th>班级名称</th>
                    <th>固定标签</th>
                    <th>成员数量</th>
                    <th>最近同步</th>
                </tr>
                </thead>
                <tbody>
                {% for item in class_overview %}
                    <tr>
                        <td>{{ item.display_name }}</td>
                        <td>{{ item.tag }}</td>
                        <td>
                            {{ item.member_count }}
                            {% set members = class_memberships.get(item.tag, []) %}
                            {% if members %}
                                <details>
                                    <summary>查看成员</summary>
                                    <ul class="compact-list">
                                        {% for member in members %}
                                            <li>{{ member.real_name or member.username }}（{{ member.username }}）</li>
                                        {% endfor %}
                                    </ul>
                                </details>
                            {% endif %}
                        </td>
                        <td>{{ item.last_synced_at or '—' }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="empty-state">尚未同步到任何班级，请使用 BNDSOJ 账号登录以初始化数据。</p>
    {% endif %}
</section>

<section class="grid two-column">
    <div class="card">
        <h2>栏目标签</h2>
        <p class="form-tip">每个班级都会自动挂载这些栏目标签。</p>
        <form class="form-inline" method="post" action="{{ url_for('admin.add_column_tag') }}">
            <label class="sr-only" for="column_tag_name">新增栏目</label>
            <input type="text" id="column_tag_name" name="tag_name" placeholder="输入栏目名称" required>
            <button type="submit" class="button primary">添加</button>
        </form>
        {% if column_tags %}
            <ul class="tag-manage-list">
                {% for tag in column_tags %}
                    <li>
                        <span>{{ tag }}</span>
                        <form method="post" action="{{ url_for('admin.delete_column_tag') }}" onsubmit="return confirm('删除栏目后会从所有班级中移除，确认继续吗？');">
                            <input type="hidden" name="tag_name" value="{{ tag }}">
                            <button type="submit" class="button danger ghost">删除</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="empty-state">还没有定义栏目。添加后便可在班级视图中筛选。</p>
        {% endif %}
    </div>

    <div class="card">
        <h2>常见标签（非栏目）</h2>
        <p class="form-tip">用于在文章中标注专题、活动等信息，班级筛选页会提供组合过滤。</p>
        <form class="form-inline" method="post" action="{{ url_for('admin.add_normal_tag') }}">
            <label class="sr-only" for="normal_tag_name">新增常见标签</label>
            <input type="text" id="normal_tag_name" name="tag_name" placeholder="输入标签名称" required>
            <button type="submit" class="button primary">添加</button>
        </form>
        {% if common_tags %}
            <ul class="tag-manage-list">
                {% for tag in common_tags %}
                    <li>
                        <span>{{ tag }}</span>
                        <form method="post" action="{{ url_for('admin.delete_normal_tag') }}" onsubmit="return confirm('确定删除该标签吗？');">
                            <input type="hidden" name="tag_name" value="{{ tag }}">
                            <button type="submit" class="button danger ghost">删除</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="empty-state">暂无非栏目常见标签。</p>
        {% endif %}
    </div>
</section>

<section class="card">
    <h2>固定标签（非班级）</h2>
    <p class="form-tip">用于手工维护的固定标签，班级标签已自动同步并不可手动删除。</p>
    <form class="form-inline" method="post" action="{{ url_for('admin.add_constant_tag') }}">
        <label class="sr-only" for="constant_tag_name">新增固定标签</label>
        <input type="text" id="constant_tag_name" name="tag_name" placeholder="输入固定标签" required>
        <button type="submit" class="button primary">添加</button>
    </form>
    {% if constant_tags %}
        <ul class="tag-manage-list">
            {% for tag in constant_tags %}
                <li>
                    <span>{{ tag }}</span>
                    <form method="post" action="{{ url_for('admin.delete_constant_tag') }}" onsubmit="return confirm('确定删除该固定标签并移除所有关联吗？');">
                        <input type="hidden" name="tag_name" value="{{ tag }}">
                        <button type="submit" class="button danger ghost">删除</button>
                    </form>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="empty-state">暂无额外固定标签。</p>
    {% endif %}
</section>

<section class="card">
    <h2>用户概况</h2>
    <p>当前共有 {{ users | length }} 位用户。</p>
    <a class="button ghost" href="{{ url_for('admin.user_list') }}">打开用户管理</a>
</section>
{% endblock %}
