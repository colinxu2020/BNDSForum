{% extends "base.html" %}
{% block title %}用户管理 - BNDS Blog{% endblock %}
{% block content %}
<section class="card">
    <header class="form-header">
        <h1>用户管理</h1>
        <p class="form-tip">
            常用标签（左侧标签树与写作页面可选）用于按需打标；
            固定标签由管理员分配，系统会自动为该用户的文章附加这些标签。
        </p>
    </header>
    <div class="action-group">
        <a class="button primary" href="{{ url_for('auth.register') }}">手动创建新用户</a>
    </div>
</section>

<section class="card">
    <h2>筛选用户</h2>
    <form id="user-filter-form" class="form-grid" method="get">
        <div class="form-field">
            <label for="filter-username">用户名</label>
            <input type="text"
                   id="filter-username"
                   name="username"
                   value="{{ filters.username }}"
                   placeholder="精确或模糊匹配用户名">
        </div>
        <div class="form-field">
            <label for="filter-real-name">真实姓名</label>
            <input type="text"
                   id="filter-real-name"
                   name="real_name"
                   value="{{ filters.real_name }}"
                   placeholder="支持模糊匹配，例如：王">
        </div>
        <fieldset class="form-field tag-filter-field">
            <legend>固定标签</legend>
            {% if constant_tags %}
                <div class="checkbox-chip-group">
                    {% for tag in constant_tags %}
                        <label class="checkbox-chip">
                            <input type="checkbox"
                                   name="constant_tag"
                                   value="{{ tag }}"
                                   {% if tag in filters.constant_tags %}checked{% endif %}>
                            <span>{{ tag }}</span>
                        </label>
                    {% endfor %}
                </div>
                <p class="field-hint">选择标签后自动应用筛选，可多选，需要全部命中。</p>
            {% else %}
                <p class="field-hint">暂无固定标签可供筛选。</p>
            {% endif %}
        </fieldset>
        <div class="form-actions">
            <button type="submit" class="button primary">应用筛选</button>
            <a class="button ghost" href="{{ url_for('admin.user_list') }}">重置</a>
        </div>
    </form>
    <p class="muted-text">符合条件：{{ matched_count }} / {{ total_users }} 人</p>
</section>

<section class="card">
    <h2>批量固定标签</h2>
    <form id="bulk-tag-form" class="bulk-tag-form" method="post" action="{{ url_for('admin.bulk_update_user_tags') }}">
        <fieldset class="bulk-tag-mode">
            <legend>选择操作</legend>
            <label class="radio-chip">
                <input type="radio" name="operation" value="add" checked>
                <span>添加固定标签</span>
            </label>
            <label class="radio-chip">
                <input type="radio" name="operation" value="remove">
                <span>移除固定标签</span>
            </label>
        </fieldset>
        <fieldset class="bulk-tag-options">
            <legend>选择固定标签</legend>
            {% if constant_tags %}
                <div class="checkbox-chip-group">
                    {% for tag in constant_tags %}
                        <label class="checkbox-chip">
                            <input type="checkbox" name="tags" value="{{ tag }}">
                            <span>{{ tag }}</span>
                        </label>
                    {% endfor %}
                </div>
                <p class="field-hint">先选择操作与标签，再在下方列表勾选用户并应用。</p>
            {% else %}
                <p class="field-hint">暂无固定标签，请在管理后台先添加。</p>
            {% endif %}
        </fieldset>
        <input type="hidden" name="return_to" value="{{ request.full_path.rstrip('?') }}">
        <button type="submit" class="button primary" data-role="bulk-apply" {% if not constant_tags %}disabled{% endif %}>
            应用到选中用户
        </button>
    </form>
</section>

<section class="card">
    <h2>用户列表</h2>
    <div class="responsive-table">
        <table>
            <thead>
            <tr>
                <th class="select-column">
                    <label class="sr-only" for="bulk-select-all">全选用户</label>
                    <input type="checkbox" id="bulk-select-all">
                </th>
                <th>真实姓名</th>
                <th>用户名</th>
                <th>角色</th>
                <th>状态</th>
                <th>固定标签</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% if users %}
                {% for user in users %}
                    {% set form_id = 'user-form-' ~ loop.index %}
                    <tr>
                        <td class="select-column">
                            <input type="checkbox"
                                   class="bulk-user-checkbox"
                                   form="bulk-tag-form"
                                   name="usernames"
                                   value="{{ user['username'] }}"
                                   aria-label="选择 {{ user['username'] }}">
                        </td>
                        <td>
                            <div class="table-control">
                                <input type="text"
                                       name="real_name"
                                       form="{{ form_id }}"
                                       value="{{ user.get('real_name', '') }}"
                                       class="table-input"
                                       placeholder="例如：王同学"
                                       required>
                            </div>
                        </td>
                        <td>
                            <a href="{{ url_for('blog.user_profile', username=user['username']) }}">{{ user['username'] }}</a>
                        </td>
                        <td>
                            <div class="table-control select-control">
                                <div class="select-shell">
                                    <select name="role" form="{{ form_id }}" class="table-select">
                                        <option value="user" {% if user['role'] == 'user' %}selected{% endif %}>普通用户</option>
                                        <option value="admin" {% if user['role'] == 'admin' %}selected{% endif %}>管理员</option>
                                    </select>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if user['is_banned'] %}
                                <span class="tag-badge danger">已封禁</span>
                            {% else %}
                                <span class="tag-badge">正常</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user['constant_tags'] %}
                                <div class="tag-collection compact">
                                    {% for tag in user['constant_tags'] %}
                                        <span class="tag-badge">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="tag-placeholder">无固定标签</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="row-actions">
                                <form id="{{ form_id }}" method="post" action="{{ url_for('admin.update_user') }}">
                                    <input type="hidden" name="username" value="{{ user['username'] }}">
                                    <input type="hidden" name="return_to" value="{{ request.full_path.rstrip('?') }}">
                                    <button type="submit" class="button primary">保存</button>
                                </form>
                                {% if user['is_banned'] %}
                                    <form method="post" action="{{ url_for('admin.unban_user', username=user['username']) }}">
                                        <input type="hidden" name="return_to" value="{{ request.full_path.rstrip('?') }}">
                                        <button type="submit" class="button ghost">解封</button>
                                    </form>
                                {% elif user['username'] != current_user.username %}
                                    <form method="post" action="{{ url_for('admin.ban_user', username=user['username']) }}">
                                        <input type="hidden" name="return_to" value="{{ request.full_path.rstrip('?') }}">
                                        <button type="submit" class="button danger ghost">封禁</button>
                                    </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7">暂无符合条件的用户，请调整筛选条件。</td>
                </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
    (function () {
        const filterForm = document.getElementById('user-filter-form');
        if (filterForm) {
            const tagFilters = filterForm.querySelectorAll('input[type="checkbox"][name="constant_tag"]');
            tagFilters.forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    if (typeof filterForm.requestSubmit === 'function') {
                        filterForm.requestSubmit();
                    } else {
                        filterForm.submit();
                    }
                });
            });
        }

        const bulkForm = document.getElementById('bulk-tag-form');
        if (!bulkForm) {
            return;
        }
        const applyButton = bulkForm.querySelector('[data-role="bulk-apply"]');
        const tagInputs = Array.from(bulkForm.querySelectorAll('input[name="tags"]'));
        const userCheckboxes = Array.from(document.querySelectorAll('.bulk-user-checkbox'));
        const selectAll = document.getElementById('bulk-select-all');

        function updateSelectAll() {
            if (!selectAll) {
                return;
            }
            if (!userCheckboxes.length) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
                selectAll.disabled = true;
                return;
            }
            selectAll.disabled = false;
            const checkedCount = userCheckboxes.filter(function (input) {
                return input.checked;
            }).length;
            selectAll.checked = checkedCount === userCheckboxes.length && checkedCount > 0;
            selectAll.indeterminate = checkedCount > 0 && checkedCount < userCheckboxes.length;
        }

        function updateApplyState() {
            const hasTag = tagInputs.some(function (input) {
                return input.checked;
            });
            const hasUser = userCheckboxes.some(function (input) {
                return input.checked;
            });
            if (applyButton) {
                applyButton.disabled = !(hasTag && hasUser);
            }
            updateSelectAll();
        }

        tagInputs.forEach(function (input) {
            input.addEventListener('change', updateApplyState);
        });
        userCheckboxes.forEach(function (input) {
            input.addEventListener('change', updateApplyState);
        });

        if (selectAll) {
            selectAll.addEventListener('change', function () {
                userCheckboxes.forEach(function (input) {
                    input.checked = Boolean(selectAll.checked);
                });
                updateApplyState();
            });
        }

        updateApplyState();
    }());
</script>
{% endblock %}
