{% extends "base.html" %}
{% block title %}Legacy 标签树配置 - BNDS Blog{% endblock %}
{% block content %}
<section class="card admin-hero">
    <h1>Legacy 标签树配置</h1>
    <p class="form-tip">
        当前系统已自动根据班级与栏目构建标签树。
        在此页面仍可对原始树结构进行细化调整，请谨慎操作。
    </p>
    <div class="action-group">
        <a class="button ghost" href="{{ url_for('admin.dashboard') }}">返回管理后台</a>
        <a class="button ghost" href="{{ url_for('tag.class_overview') }}">前往班级视图</a>
    </div>
</section>

<section class="card">
    <h2>添加标签树节点</h2>
    <form class="form-grid" method="post" action="{{ url_for('admin.add_tree_node') }}">
        <div class="form-field">
            <label for="parent_id">父节点</label>
            <select id="parent_id" name="parent_id" required>
                {% for option in parent_choices %}
                    <option value="{{ option.id }}">{{ option.label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-field">
            <label for="node_tag">节点标签</label>
            <select id="node_tag" name="tag_name">
                <option value="">（不设置标签）</option>
                {% if constant_tags %}
                    <optgroup label="固定标签">
                        {% for tag in constant_tags %}
                            <option value="{{ tag }}">{{ tag }}</option>
                        {% endfor %}
                    </optgroup>
                {% endif %}
                {% if normal_tags %}
                    <optgroup label="常用标签">
                        {% for tag in normal_tags %}
                            <option value="{{ tag }}">{{ tag }}</option>
                        {% endfor %}
                    </optgroup>
                {% endif %}
            </select>
            <p class="field-hint">可选择已有标签或创建占位节点；根节点固定代表所有文章。</p>
        </div>
        <div class="form-actions">
            <button type="submit" class="button primary">添加节点</button>
        </div>
    </form>
</section>

<section class="card">
    <h2>标签树概览</h2>
    <div class="responsive-table">
        <table>
            <thead>
            <tr>
                <th>节点 ID</th>
                <th>路径</th>
                <th>标签名称</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>
            {% for row in tree_rows %}
                <tr>
                    <td>{{ row.id }}</td>
                    <td>{{ ' / '.join(row.path) if row.path else '根节点' }}</td>
                    <td>{{ row.tag or '（空）' }}</td>
                    <td>
                        {% if not row.is_root %}
                            <form class="inline-form" method="post" action="{{ url_for('admin.update_tree_node') }}">
                                <input type="hidden" name="node_id" value="{{ row.id }}">
                                <input type="text" name="tag" value="{{ row.tag or '' }}" placeholder="标签名称">
                                <button type="submit" class="button ghost">更新</button>
                            </form>
                            <form class="inline-form" method="post" action="{{ url_for('admin.delete_tree_node') }}" onsubmit="return confirm('确定删除该节点及其所有子节点吗？');">
                                <input type="hidden" name="node_id" value="{{ row.id }}">
                                <button type="submit" class="button danger ghost">删除</button>
                            </form>
                        {% else %}
                            <span class="muted-text">根节点不可修改</span>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
